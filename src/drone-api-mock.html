<link rel="import" href="../bower_components/polymer/polymer.html">

<script src="../bower_components/rxjs/dist/rx.lite.min.js"></script>

<script>
  DroneMock = function(token) {
    this._token = token;
    this._subjects = {};
  };

  DroneMock.prototype.connect = function() {
    DroneMock._feedQuery(this);
  }

  DroneMock.prototype.getBuilds = function(owner, name) {
    var path = owner + '/' + name;
    console.log('Getting builds from ' + path);
    var subject = this._subjects[path];

    if (!subject) {
      subject = new Rx.Subject();

      this._subjects[path] = subject;
    }

    return subject;
  };

  DroneMock._feedInterval = 1000;

  DroneMock._feedQuery = function(api) {
    var data = Rx.Observable.interval(DroneMock._feedInterval);
    var subscription = data.subscribe(
      function (x) {
          console.log('Next: ' + x);

          var subject = api._subjects['drone/drone'];

          if (subject) {
            if (x > 0) {
              subject.onNext({
                "id":4614 + x - 1,
                "number":x,
                "event":"pull_request",
                "status":"success",
                "enqueued_at":1467571055,
                "created_at":1467571055,
                "started_at":1467571055,
                "finished_at":0,
                "deploy_to":"",
                "commit":"ece6806da16ccd4fbb632e0159839159ae1babf6",
                "branch":"feature/job-indexof",
                "ref":"refs/pull/1698/merge",
                "refspec":"",
                "remote":"",
                "title":"Add IndexOf and Length to Queue",
                "message":"Add IndexOf and Length to Queue",
                "timestamp":0,
                "author":"donny-dont",
                "author_avatar":"https://avatars.githubusercontent.com/u/666297?v=3",
                "author_email":"don.j.olmstead@gmail.com",
                "link_url":"https://github.com/drone/drone/pull/1698",
                "signed":true,
                "verified":true
              })
            }
            subject.onNext({
              "id":4614 + x,
              "number":x,
              "event":"pull_request",
              "status":"running",
              "enqueued_at":1467571055,
              "created_at":1467571055,
              "started_at":1467571055,
              "finished_at":0,
              "deploy_to":"",
              "commit":"ece6806da16ccd4fbb632e0159839159ae1babf6",
              "branch":"feature/job-indexof",
              "ref":"refs/pull/1698/merge",
              "refspec":"",
              "remote":"",
              "title":"Add IndexOf and Length to Queue",
              "message":"Add IndexOf and Length to Queue",
              "timestamp":0,
              "author":"donny-dont",
              "author_avatar":"https://avatars.githubusercontent.com/u/666297?v=3",
              "author_email":"don.j.olmstead@gmail.com",
              "link_url":"https://github.com/drone/drone/pull/1698",
              "signed":true,
              "verified":true
           });
          }
      },
      function (err) {
          console.log('Error: ' + err);
      },
      function () {
          console.log('Completed');
      }
    );
  }
</script>
