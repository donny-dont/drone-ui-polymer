
<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
  /**
   * @polymerBehavior
   */
  ModelFeed = {
    properties: {
      models: {
        type: Array,
        notify: true,
        value: []
      },
      uniqueKey: {
        type: String,
        value: 'id',
      },
    },
    attached: function() {
      this.fire('register-connection', this);
    },
    connect: function(connection) {
      console.log('Got connection');
      this.connection = connection;
      this.subscribe();
    },
    subscribe: function() {
      // Sanity check
      if (!this.connection) {
        console.log('Oh boy this is bad');
        var stack = new Error().stack;
        console.dir(this);
        console.log(stack);
        return;
      }

      // Remove old subscription
      this.unsubscribe();

      if (!this.isReady()) {
        return;
      }

      // Subscribe
      var that = this;

      this.subscription = this.getFeed().subscribe(
        function (value) {
          console.log(that.tagName);
          // See if the value is present
          var models = that.models,
              count = models.length,
              key = that.uniqueKey,
              id = value[key];

          console.log('Adding model ' + id);
          console.log(models.length);

          for (var i = 0; i < count; ++i) {
            if (models[i][key] === id) {
              console.log('Updating model at ' + i);
              that.set('models.' + i, value);
              return;
            }
          }

          that.unshift('models', value);
        },
        function (error) {
          console.log('HAVE ERROR');
          console.dir(error)

          that.fire('model-error', {error: error});
        }
      );
    },
    unsubscribe: function() {
      if (this._subscription) {
        // Remove subscription
        this._subscription.dispose();
        this._subscription = null;
      }

      // Clear values
      console.log('unsubscribe');
      this.splice('models', 0, this.models.length);
    },
    isReady: function() { return true; },
    getFeed: function() { return null; }
  }
</script>
