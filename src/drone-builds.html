<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="drone-api.html">

<dom-module id="drone-builds">
  <template>
    <style>
      :host { display: none; }
    </style>
  </template>
  <script>
    Polymer({
      is: 'drone-builds',
      properties: {
        owner: String,
        name: String,
        models: {
          type: Array,
          notify: true,
          value: []
        }
      },
      observers: [
        '_subscribe(owner, name)'
      ],
      _subscribe: function(owner, name) {
        if (!this._drone) {
          this._drone = new Drone();
          this._drone.connect();
        }

        if (this._subscription) {
          this._subscription.dispose();
          this.splice('models', 0, this.models.length);
        }

        var that = this;
        this._subscription = this._drone.getBuilds(owner, name).subscribe(
          function (value) {
            console.log(value.id);
            // See if the build is present
            var models = that.models;
            var count = models.length;
            var id = value.id;

            for (var i = 0; i < count; ++i) {
              if (models[i].id === id) {
                console.log('Updating model at ' + i);
                that.set('models.' + i, value);
                return;
              }
            }

            that.unshift('models', value);
          },
          function (error) {

          }
        )
      }
    })
  </script>
</dom-module>
